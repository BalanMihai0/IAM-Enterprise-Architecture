version: 2.1
orbs:
 node: circleci/node@5
jobs:
 build-frontend:
    executor: node/default
    working_directory: ~/project/iam-enterprise-architecture-frontend
    steps:
      - checkout:
          path: ~/project
      - node/install-packages:
          pkg-manager: npm
      - run:
          command: npm run build
      - run:
          name: Create the ~/artifacts directory if it doesn't exist
          command: mkdir -p ~/artifacts
      # Copy output to artifacts dir
      - run:
          name: Copy artifacts
          command: cp -R build dist public .output .next .docusaurus ~/artifacts 2>/dev/null || true
      - store_artifacts:
          path: ~/artifacts
          destination: frontend-build

 build-backend:
    executor: node/default
    working_directory: ~/project/iam-enterprise-architecture-backend
    steps:
      - checkout:
          path: ~/project
      - node/install-packages:
          pkg-manager: npm
      - run:
          command: npm run build
      - run:
          name: Create the ~/artifacts directory if it doesn't exist
          command: mkdir -p ~/artifacts
      # Copy output to artifacts dir
      - run:
          name: Copy artifacts
          command: cp -R build dist public .output .next .docusaurus ~/artifacts 2>/dev/null || true
      - store_artifacts:
          path: ~/artifacts
          destination: backend-build

 test-backend:
    executor: node/default
    working_directory: ~/project/iam-enterprise-architecture-backend
    steps:
      - checkout:
          path: ~/project
      - node/install-packages:
          pkg-manager: npm
      - run:
          command: npm test

          
 sonarqube-analysis:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - run:
          name: Install SonarQube Scanner
          command: |
            sudo apt-get update
            sudo apt-get install -y openjdk-11-jdk
            wget -O sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.6.2.2472-linux.zip
            unzip sonar-scanner.zip
            rm sonar-scanner.zip
      - run:
          name: Run SonarQube Scanner
          command: |
            export PATH="$PATH:$PWD/sonar-scanner-4.6.2.2472-linux/bin"
            sonar-scanner \
            -Dsonar.projectKey=your_project_key \
            -Dsonar.host.url=http://localhost:9000 \
            -Dsonar.login=$SONAR_TOKEN \
            -Dsonar.sources=./iam-enterprise-architecture-backend


 deploy:
    # This is an example deploy job, not actually used by the workflow
    docker:
      - image: cimg/base:stable
    steps:
      # does nothing atm
      - run:
          name: deploy
          command: echo 'Deploy not implemented'

workflows:
 build:
    jobs:
      - build-frontend
      - build-backend
      - test-backend:
          requires:
            - build-backend
      - sonarqube-analysis
          requires:
            - build-backend
            - test-backend
            - build-frontend
      - deploy:
          requires:
            - sonarqube-analysis
